<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TimeBalance Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        body { height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        #calendar-container { flex: 1; overflow-y: auto; scrollbar-width: thin; }
        .day-card { transition: background-color 0.1s; min-height: 60px; user-select: none; -webkit-user-select: none; touch-action: none; }
        @media (min-width: 768px) { .day-card { min-height: 90px; } }
        .day-selected { border: 2px solid #3b82f6; background-color: #eff6ff; }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        @keyframes slideDown { from { transform: translate(-50%, -100%); opacity: 0; } to { transform: translate(-50%, 0); opacity: 1; } }
        .popup-alert { animation: slideDown 0.3s ease-out forwards; }
        button:disabled { opacity: 0.3; cursor: not-allowed; filter: grayscale(1); }
    </style>
</head>
<body class="bg-slate-100 font-sans text-slate-800">

    <div id="alertGlobal" class="hidden fixed top-5 left-1/2 -translate-x-1/2 z-50 popup-alert shadow-2xl">
        <div class="bg-red-600 text-white px-6 py-3 rounded-full flex items-center gap-3 border-2 border-white shadow-lg">
            <span class="font-bold whitespace-nowrap text-xs md:text-sm">Limite de 2h/dia excedido!</span>
        </div>
    </div>

    <header class="bg-indigo-950 p-3 md:p-4 text-white flex justify-between items-center shadow-md shrink-0">
        <h1 class="text-lg md:text-2xl font-black tracking-tighter italic">TIME<span class="text-blue-400">BALANCE</span></h1>
        <button id="btnPDF" disabled onclick="exportToPDF()" class="bg-blue-600 text-white px-3 py-1.5 rounded-lg font-bold text-xs hover:bg-blue-500 transition shadow-lg">Gerar PDF</button>
    </header>

    <main class="flex-1 flex flex-col lg:flex-row overflow-hidden max-w-7xl mx-auto w-full p-2 md:p-4 gap-4">
        <aside class="w-full lg:w-64 space-y-3 shrink-0">
            <div class="grid grid-cols-2 lg:grid-cols-1 gap-3">
                <div class="bg-white p-3 rounded-xl border border-slate-200 shadow-sm">
                    <label class="block text-[8px] font-black text-slate-400 uppercase mb-1">Saldo Inicial</label>
                    <input type="number" id="currentBalance" value="0" step="0.5" 
                           class="block w-full bg-transparent border-none p-0 text-xl md:text-2xl font-mono font-black text-indigo-900 focus:ring-0 outline-none" 
                           oninput="renderCalendar()"
                           onfocus="if(this.value==='0')this.value=''" 
                           onblur="if(this.value==='')this.value='0'">
                </div>
                <div id="statusCard" class="p-3 rounded-xl text-white shadow-md bg-slate-400 transition-colors flex flex-col justify-center">
                    <h2 class="text-[8px] uppercase font-black opacity-80">Saldo Restante</h2>
                    <div class="text-xl md:text-2xl font-black font-mono tracking-tighter" id="remainingValue">0h 00min</div>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="autoSuggest()" class="flex-1 bg-slate-800 text-white text-[10px] font-bold py-3 rounded-xl shadow hover:bg-black transition">ðŸª„ Sugerir</button>
                <button onclick="clearAll()" class="flex-1 bg-white border border-slate-200 text-slate-500 text-[10px] font-bold py-3 rounded-xl hover:text-red-500 transition">Limpar</button>
            </div>
        </aside>

        <section class="flex-1 bg-white rounded-2xl shadow-xl border border-slate-200 flex flex-col overflow-hidden">
            <div class="flex justify-between items-center p-3 border-b border-slate-100 bg-slate-50/50 shrink-0">
                <button onclick="changeMonth(-1)" class="p-2 hover:bg-white rounded-lg transition text-slate-600"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg></button>
                <div class="text-center">
                    <h2 id="monthLabel" class="text-sm md:text-base font-black text-slate-900 uppercase tracking-tighter"></h2>
                    <div id="indicator" class="text-[8px] font-bold uppercase tracking-widest text-slate-400"></div>
                </div>
                <button onclick="changeMonth(1)" class="p-2 hover:bg-white rounded-lg transition text-slate-600"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg></button>
            </div>
            <div class="grid grid-cols-7 gap-1 px-3 py-2 text-center text-[8px] font-black text-slate-400 uppercase border-b border-slate-50 shrink-0">
                <div>Dom</div><div>Seg</div><div>Ter</div><div>Qua</div><div>Qui</div><div>Sex</div><div>SÃ¡b</div>
            </div>
            <div id="calendar-container">
                <div id="calendar" class="grid grid-cols-7 gap-1 md:gap-2 cursor-grab"></div>
            </div>
        </section>
    </main>

    <script>
        let selectedDays = [];
        let viewDate = new Date();
        let isDragging = false;
        let dragTargetState = true;

        function formatTime(decimalHours) {
            const h = Math.floor(Math.abs(decimalHours));
            const m = Math.round((Math.abs(decimalHours) - h) * 60);
            return `${h}h${m > 0 ? ' '+m+'m' : ''}`;
        }

        function changeMonth(offset) {
            viewDate.setMonth(viewDate.getMonth() + offset);
            renderCalendar();
        }

        function renderCalendar() {
            const grid = document.getElementById('calendar');
            const initialBalance = parseFloat(document.getElementById('currentBalance').value) || 0;
            const year = viewDate.getFullYear();
            const month = viewDate.getMonth();
            const daysInMonth = new Array(31).fill('').map((_, i) => new Date(year, month, i + 1)).filter(d => d.getMonth() === month);
            
            document.getElementById('monthLabel').innerText = viewDate.toLocaleString('pt-br', { month: 'long', year: 'numeric' });
            grid.innerHTML = '';
            for (let i = 0; i < daysInMonth[0].getDay(); i++) grid.innerHTML += '<div></div>';

            const sorted = [...selectedDays].sort((a, b) => new Date(a) - new Date(b));
            const isNegative = initialBalance < 0;
            const rateio = (isNegative && selectedDays.length > 0) ? (Math.abs(initialBalance) / selectedDays.length) : 0;

            daysInMonth.forEach(date => {
                const dateStr = date.toISOString().split('T')[0];
                const isSelected = selectedDays.includes(dateStr);
                const isSun = date.getDay() === 0;
                let hours = 0;

                if (isSelected && !isSun) {
                    if (isNegative) hours = rateio;
                    else {
                        let acc = 0;
                        const idx = sorted.indexOf(dateStr);
                        for (let i = 0; i < idx; i++) {
                            const d = new Date(sorted[i] + 'T00:00:00');
                            if (d.getDay() !== 0) acc += Math.min(d.getDay() === 6 ? 4 : 8, Math.max(0, initialBalance - acc));
                        }
                        hours = Math.min(date.getDay() === 6 ? 4 : 8, Math.max(0, initialBalance - acc));
                    }
                }

                const card = document.createElement('div');
                card.dataset.date = dateStr;
                card.dataset.isSun = isSun;
                card.className = `day-card p-1 md:p-2 border rounded-lg flex flex-col justify-between items-center md:items-start ${isSun ? 'bg-slate-50 text-slate-300' : 'bg-white shadow-sm'} ${isSelected ? 'day-selected' : 'border-slate-100'}`;
                card.innerHTML = `<span class="text-xs md:text-sm font-black ${isSelected ? 'text-blue-600' : 'text-slate-700'}">${date.getDate()}</span>` + 
                    (hours > 0.01 ? `<div class="${isNegative && rateio > 2 ? 'bg-red-500' : (isNegative ? 'bg-emerald-500' : 'bg-blue-600')} text-white text-[7px] md:text-[9px] font-bold px-1 py-0.5 rounded mt-1 truncate w-full text-center">${isNegative ? '+' : '-'}${formatTime(hours)}</div>` : '');
                
                // Eventos Mouse
                card.onmousedown = (e) => {
                    if (isSun) return;
                    isDragging = true;
                    dragTargetState = !selectedDays.includes(card.dataset.date);
                    toggleDay(card.dataset.date, dragTargetState);
                };
                card.onmousemove = (e) => { if (isDragging && !isSun) toggleDay(card.dataset.date, dragTargetState); };

                // Eventos Touch InstantÃ¢neos
                card.ontouchstart = (e) => {
                    if (isSun) return;
                    isDragging = true;
                    dragTargetState = !selectedDays.includes(card.dataset.date);
                    toggleDay(card.dataset.date, dragTargetState);
                };
                card.ontouchmove = (e) => {
                    if (!isDragging) return;
                    const t = document.elementFromPoint(e.touches[0].clientX, e.touches[0].clientY)?.closest('.day-card');
                    if (t && t.dataset.isSun === "false") toggleDay(t.dataset.date, dragTargetState);
                };

                grid.appendChild(card);
            });
            updateUI(initialBalance, isNegative, rateio > 2);
        }

        function toggleDay(date, state) {
            const idx = selectedDays.indexOf(date);
            if (state && idx === -1) {
                selectedDays.push(date);
                renderCalendar();
            } else if (!state && idx > -1) {
                selectedDays.splice(idx, 1);
                renderCalendar();
            }
        }

        function updateUI(initial, isNeg, exceeded) {
            let total = 0;
            if (!isNeg) {
                const sorted = [...selectedDays].sort((a, b) => new Date(a) - new Date(b));
                sorted.forEach(dStr => {
                    const d = new Date(dStr + 'T00:00:00');
                    if (d.getDay() !== 0) total += Math.min(Math.max(0, initial - total), d.getDay() === 6 ? 4 : 8);
                });
            }
            const rem = isNeg ? (selectedDays.length > 0 ? 0 : Math.abs(initial)) : Math.max(0, initial - total);
            document.getElementById('remainingValue').innerText = formatTime(rem);
            document.getElementById('statusCard').className = `p-3 rounded-xl text-white transition-colors flex flex-col justify-center ${initial === 0 ? 'bg-slate-400' : (isNeg ? (exceeded ? 'bg-red-500' : 'bg-emerald-600') : 'bg-blue-600')}`;
            document.getElementById('indicator').innerText = initial === 0 ? "" : (isNeg ? "MODO EXTRAS" : "MODO FOLGAS");
            document.getElementById('alertGlobal').style.display = (isNeg && exceeded) ? 'block' : 'none';
            document.getElementById('btnPDF').disabled = (initial === 0 || selectedDays.length === 0);
        }

        function autoSuggest() {
            let bal = parseFloat(document.getElementById('currentBalance').value) || 0;
            if (bal === 0) return;
            selectedDays = [];
            const tomorrow = new Date(); tomorrow.setDate(tomorrow.getDate() + 1); tomorrow.setHours(0,0,0,0);
            let startPoint = new Date(viewDate.getFullYear(), viewDate.getMonth(), 1);
            if (startPoint < tomorrow) startPoint = tomorrow;
            let temp = Math.abs(bal), cur = new Date(startPoint);
            while(temp > 0.01 && selectedDays.length < 60) {
                if (cur.getDay() !== 0) {
                    selectedDays.push(cur.toISOString().split('T')[0]);
                    temp -= (bal > 0 ? (cur.getDay() === 6 ? 4 : 8) : 2);
                }
                cur.setDate(cur.getDate() + 1);
            }
            renderCalendar();
        }

        function clearAll() { selectedDays = []; renderCalendar(); }

        function exportToPDF() {
            const area = document.getElementById('calendar-container').cloneNode(true);
            const wrapper = document.createElement('div');
            wrapper.style.padding = "20px"; wrapper.style.width = "1050px";
            const label = document.getElementById('monthLabel').cloneNode(true);
            label.style.textAlign = "center"; label.style.marginBottom = "20px"; label.style.fontSize = "24px";
            wrapper.appendChild(label);
            wrapper.appendChild(area);
            html2pdf().set({ margin: 0.3, filename: 'TimeBalance.pdf', html2canvas: { scale: 2 }, jsPDF: { orientation: 'landscape' } }).from(wrapper).save();
        }

        const stopDrag = () => { isDragging = false; };
        document.addEventListener('mouseup', stopDrag);
        document.addEventListener('touchend', stopDrag);

        renderCalendar();
    </script>
</body>
</html>